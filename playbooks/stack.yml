- name: Install and Configure MariaDB
  hosts: TEST
  gather_facts: no
  tags:
    - DB
  vars:
    DBNAME: studentapp
    DBUSER: student
    DBPASS: student@1
  become: yes 
  tasks:
    - name: Install MariaDB Server 
      package:
        name: "{{item}}"
        state: present
      with_items:
        - MySQL-python
        - mariadb-server

    - name: Start MariaDB 
      service:
        name: mariadb
        state: started 
        enabled: yes 
        
    - name: Create Student DB in MariaDB
      mysql_db:
        name: "{{DBNAME}}"
        state: present 
      
    - name: Copy SQL file 
      copy:
        src: files/studentapp.sql 
        dest: /tmp/studentapp.sql 

    - name: Create Database schema 
      mysql_db:
        state: import
        name: all
        target: /tmp/studentapp.sql

    - name: Create DB User 
      mysql_user:
        name: "{{DBUSER}}"
        password: "{{DBPASS}}"
        host: workstation.c.devops26-195800.internal
        host_all: yes
        priv: "{{DBNAME}}.*:ALL,GRANT"
        state: present

- name: Install and Configure Tomcat
  hosts: TEST
  become: yes
  gather_facts: no
  tags:
    - APP
  vars:
    TURL: https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.29/bin/apache-tomcat-8.5.29.tar.gz
  tasks:
    - name: Install Java 
      package:
        name: java 
        state: installed 

    - name: Get tar dir
      shell: echo {{TURL}} | awk -F / '{print $NF}' | sed -e 's/.tar.gz//'
      register: out 

    - name: Define TAR Dir Variable 
      set_fact:
        T_DIR: "/opt/{{out.stdout}}"

    - name: Check Tomcat exists or not. 
      stat:
        path: "{{T_DIR}}"
      register: out 

    - name: Download Tomcat and extract it
      unarchive:
        src: "{{TURL}}"
        dest: "/opt"
        remote_src: yes
      when: out.stat.exists == false

    - name: Find webapps 
      find:
        paths: "{{T_DIR}}/webapps"
        file_type: any
      register: out

    - name: Delete files 
      file:
        path: "{{item.path}}"
        state: absent
      with_items: "{{out.files}}"

    - name: Download War file 
      get_url:
        url: https://github.com/cit-ager/APP-STACK/raw/master/student.war
        dest: "{{T_DIR}}/webapps/student.war"

    - name: Download JDBC jar file 
      get_url: 
        url: https://github.com/cit-ager/APP-STACK/raw/master/mysql-connector-java-5.1.40.jar
        dest: "{{T_DIR}}/lib/mysql-connector-java-5.1.40.jar"
        
    

